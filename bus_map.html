
<!-- 1.00 Pset 1 -------------------------------- -->

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Semi-realtime MBTA mapping</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }

.map-overlay {
  position: absolute;
  left: 0;
  padding: 10px;
}
 
</style>
</head>
<body>
  <div id="map"></div>

  <div class="map-overlay top">
    <button style="font-size: 2em" onclick="move()">
      Show Route
    </button>
  </div>

  <script>
    async function run(){
      // request bus data
      var locations = await getBusLocations();
      console.log(new Date());
      
      var location = [];
        locations.forEach(function org(bus){
          var id = bus.id;
          var lat = bus.attributes.latitude;
          var lng = bus.attributes.longitude;
          var units = location.push(id,lng,lat);    
        });
      if (location.length>21){console.log('need more markers')};
      return location;
    }

  async function getBusLocations(){
      const url='https://api-v3.mbta.com/vehicles?filter[route]=1&include=trip';
      const response = await fetch(url);
      const json = await response.json();
      return json.data;
  }
    
    // api token
    mapboxgl.accessToken = 'pk.eyJ1Ijoic29mdGV4cGVyaW1lbnQiLCJhIjoiY2tjMngyZm9rMDFvajJzczJ3aWo0bnh6aiJ9.Bc_qK9Xf8SFBXkFM_x2gpg';

    // map instance
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-71.0906, 42.3616], //center on MIT campus
        zoom: 15
    });

    // create map markers
    var marker1 = new mapboxgl.Marker()
        .setLngLat([-71.0906, 42.3616]) //center on 77 Mass Ave
        .addTo(map);

    var marker2 = new mapboxgl.Marker()
        .setLngLat([-71.0906, 42.3616]) //center on 77 Mass Ave
        .addTo(map);

    var marker3 = new mapboxgl.Marker()
        .setLngLat([-71.0906, 42.3616]) //center on 77 Mass Ave
        .addTo(map);

    var marker4 = new mapboxgl.Marker()
        .setLngLat([-71.0906, 42.3616]) //center on 77 Mass Ave
        .addTo(map);

    var marker5 = new mapboxgl.Marker()
        .setLngLat([-71.0906, 42.3616]) //center on 77 Mass Ave
        .addTo(map);
    
    var marker6 = new mapboxgl.Marker()
        .setLngLat([-71.0906, 42.3616]) //center on 77 Mass Ave
        .addTo(map);

    var marker7 = new mapboxgl.Marker()
        .setLngLat([-71.0906, 42.3616]) //center on 77 Mass Ave
        .addTo(map);

    // animate marker
    let counter = 1;

    var walker = async function(wherebuses){
          var bus_loc = await wherebuses;
          //if(counter >= busStops.length) return;
          marker1.setLngLat(await [bus_loc[1],bus_loc[2]]);
          marker2.setLngLat([bus_loc[4],bus_loc[5]]);
          marker3.setLngLat([bus_loc[7],bus_loc[8]]);
          marker4.setLngLat([bus_loc[10],bus_loc[11]]);
          marker5.setLngLat([bus_loc[13],bus_loc[14]]);
          marker6.setLngLat([bus_loc[16],bus_loc[17]]);
          if (location.length>18){marker7.setLngLat([bus_loc[19],bus_loc[20]])}
          else {marker7.remove()};
          //marker.setLngLat(busStops[counter]); //set marker to bus stop
          //counter = counter+3; //inc counter
          move() //recall
        }

    async function move(){
      setTimeout(async function() {await walker(await run());}, 15000); // can't do too often, will get banned
    }

  //'https://api-v3.mbta.com/vehicles?filter[route]=1&include=trip'
 </script>
</body>
</html>
